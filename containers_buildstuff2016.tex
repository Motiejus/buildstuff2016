% create a diagram how network namespaces work
% remember we are still a non-root? Let's apply tc.
% add namespace stuff to the container script
% tc qdisc add dev eth0 root netem delay 100ms

% The talk was very understandable. The presentation was very clear to me. Too
% bad the demo didn't work out as expected, it was not very clear to me what
% the (performance) benefit was in the demo, and maybe some numbers on a slide
% would have helped.

% Improvement: the speaker could practice on not having so many stop-and-start
% moments, realizing halfway through the talk what he was still going to say.
 
\documentclass[14pt]{beamer}
\usetheme{default}
\usepackage{graphics}
\usepackage{array}
\usepackage{verbatim}
\usepackage{hyperref}
\usepackage{biblatex}
\usepackage{tabularx}
\usepackage{soul}
\usepackage{mdframed}
\usepackage{tikz}
\usepackage{adjustbox}
\usepackage{mathtools}
\usepackage{caption}
\usepackage{fancyvrb}
\usepackage{subcaption}
\captionsetup{compatibility=false}

\usetikzlibrary{arrows,decorations.pathmorphing,backgrounds,positioning,fit,petri}

\definecolor{uberblack}{RGB}{9,9,26}
\definecolor{uberwhite}{RGB}{192,192,200}
\definecolor{uberblue}{RGB}{31,186,214}
\setbeamercolor{title}{fg=uberblue}
\setbeamercolor{frametitle}{fg=uberblue}
\setbeamercolor{item}{fg=uberblue}
\setbeamercolor{navigation symbols dimmed}{fg=uberwhite}
\setbeamercolor{navigation symbols}{fg=uberwhite}

\hypersetup{linkcolor=}
\hypersetup{urlcolor=uberblue} % Does not apply color to href's
\hypersetup{colorlinks,urlcolor=uberblue} % href's are correct, but navigation links are magenta

\mode<presentation>{
    \setbeamertemplate{navigation symbols}{
        \insertslidenavigationsymbol
        \insertframenavigationsymbol
        \hspace{0.2cm}
        \begin{minipage}[c]{0.5cm}
            \vspace{-0.1cm}
            {\strut\insertframenumber{}/\inserttotalframenumber\strut}
        \end{minipage}
    }
}

\setbeamertemplate{footline}[text line]{%
\parbox{\linewidth}{
\vspace*{-8pt}\color{gray}
\textcircled{c}~2016. Uber Technologies Inc. All rights reserved.
}}

\newcommand{\framedgraphic}[2] {
    \begin{frame}{#1}
        \begin{center}
            \includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]{#2}
        \end{center}
    \end{frame}
}

\newcommand{\withcredits}[3]
{
    \begin{minipage}[t][#1\textheight]{\textwidth}
        \vspace{5px}
        #2
    \end{minipage}
    \vfill
    \color{white}{\tiny Image source: #3}
}

%% =============================================================================

\title{Building blocks of Linux Containers}
\author{Motiejus Jak\v{s}tys \\
    motiejus@uber.com \\
    @mo\_kelione \\
    \vspace{1em}
    \includegraphics[height=1em]{media/svg_uberlogo.pdf}
}

\date{2016-11-18}

\begin{document}

\AtBeginSection[]
{
  \begin{frame}
    \frametitle{Table of Contents}
    \tableofcontents[currentsection]
  \end{frame}
}

\begin{frame}
\titlepage
\end{frame}

\section{Introduction}
\subsection{Why me}
\begin{frame}{Why me}
    My resume:
    \begin{itemize}
        \item $2009-2011$ Telecom (Ops).
        \item $2011-2012$ Telecom (Dev).
        \item $2012-2014$ Online Gaming (Dev + Ops).
        \item $2014-2016$ Amazon (Dev + Ops).
        \item $2016-now$ Uber SRE (Dev + Ops).
    \end{itemize}
    \onslide<+(1)->{Got a habit to cut layers of abstraction.}
\end{frame}

\subsection{A container in Linux is...}
\begin{frame}{A container in linux is ...}
    \pause
    Fork/exec with bells \& whistles:
    \begin{itemize}[<+(1)->]
        \item Fancy tarball for distribution.
        \item COW filesystem to make it start fast.
        \item Cgroups for fairness.
        \item Namespaces for isolation.
    \end{itemize}
\end{frame}

\section{Cgroups and Namespaces}
\begin{frame}{Cgroups vs Namespaces}
    \begin{description}[<+(1)->]
        \item[cgroups] help resource use fair (cpu, network, memory).
        \item[namespaces] hide things.
    \end{description}
\end{frame}

\section{Namespaces}
\subsection{Isolation in Linux}
\begin{frame}{We will cover}
    \begin{itemize}[<+(1)->]
        \item User namespaces.
        \item Pid namespaces.
        \item Mount namespaces.
        \item Network namespaces.
        \item There are more, but not today.
    \end{itemize}
\end{frame}

\begin{frame}{User namespace}
    Become root in your container. \\
    {
        \tt unshare --map-root-user
    }
\end{frame}

\begin{frame}{Mount namespace}
    Hide container mounts. \\
    {
        \tt unshare --mount
    }
\end{frame}

\begin{frame}{Pid namespace}
    Hide other pids. \\
    {
        \tt unshare --pid --mount-proc --fork
    }
\end{frame}

\begin{frame}{Network namespace}
    Preview demo:
    \begin{itemize}[<+(1)->]
        \item Create namespace.
        \item Activate loopback ({\tt lo}).
        \item Create pair of devices {\tt veth1a} and {\tt veth1b}:
            \begin{itemize}
                \item {\tt veth1b} will go to the namespace.
                \item {\tt veth1a} will stay in default.
            \end{itemize}
        \item Add ip addresses.
        \item curl and ping.
    \end{itemize}
\end{frame}

\subsection{What did we just do}
\begin{frame}{What did we just do}
    \relax
    {\bf Created a container:}
    \begin{description}[<+(1)->]
        \item[User namespace] apt-get, iptables, mount, etc.
        \item[Isolated pids] no {\tt nobody}, isolate from each other.
        \item[Isolated mounts] e.g. for /tmp.
        \item[Isolated network] safely bind to {\tt :80}.
    \end{description}
    \onslide<+(1)->{An improvement over "run and hope it doesn't affect anything else".}
\end{frame}

\section{File systems and COW}
\begin{frame}{File systems and COW}
    A container:
    \begin{itemize}[<+->]
        \item Needs a file system.
        \item Starts quickly regardless of size.
    \end{itemize}
    \visible<+->{Do not want to copy 1GB with every startup.} \\
    \visible<+->{Copy On Write!}
\end{frame}

\begin{frame}{A quick demo}
    \small
    \begin{itemize}
        \item Create {\tt tank/images/debian@latest}
        \item Create {\tt tank/containers/t1} from {\tt @latest}
        \item {\tt unshare --mount --pid --fork chroot . bash}
    \end{itemize}
\end{frame}

\section{What did we forget?}
\subsection{Leftover elephants in the room}
\begin{frame}{Leftover elephants in the room}
    \begin{itemize}[<+(1)->]
        \item Trivial to escape this "container".
        \item Sec: no leftover file descriptors.
        \item Resource fairness.
        \item Sec/DoS: shared kernel resources.
        \item Supervision, daemonization and cleanup.
        \item Logging.
        \item Collect zombie processes.
        \item Image management.
    \end{itemize}
    \visible<+(1)->{Should someone else do it?}
\end{frame}

\subsection{There is a market}
\begin{frame}{There is a market for these scripts}
    Hell yes! There is a big market:
    \begin{itemize}[<+(1)->]
        \item CoreOS Inc. raised \$48M.
        \item Docker Inc. raised \$168M.
        \item There are more companies...
    \end{itemize}
    \visible<+(1)->{... heavily funding script development.}
\end{frame}

\subsection{Real takeaways}
\begin{frame}{Real takeaways}
    \pause
    Devil is in the details (worth \$MM), better re-use:
    \begin{itemize}[<+(1)->]
        \item systemd-nspawn
        \item rkt
        \item runc
        \item docker
        \item lxc/lxd
        \item Solaris Zones (can run Linux binaries).
            \begin{itemize}
                \item Worth a separate talk.
            \end{itemize}
    \end{itemize}
\end{frame}

\subsection{Conclusions}
\begin{frame}{Conclusions}
    \begin{itemize}[<+->]
        \item Easy to understand kernel facilities.
        \item Devil is in the details.
        \item Re-use tools or raise \$MM to create yours.
    \end{itemize}
\end{frame}

\section{The End}
\begin{frame}{We're hiring!}
    \begin{itemize}
        \item Check out \href{http://join.uber.com}{join.uber.com}
        \item Also, contact me at \href{mailto:motiejus@uber.com}{motiejus@uber.com}
    \end{itemize}
\end{frame}

\begin{frame}{QA}
\end{frame}

\end{document}
