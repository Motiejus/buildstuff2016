#!/bin/bash
set -x

NS=netns1

sudo ip netns add $NS
sudo ip netns exec $NS ip link set dev lo up
sudo ip link add veth1a type veth peer name veth1b
sudo ip link set veth1a up
sudo ip addr add 10.0.0.1/24 dev veth1a

sudo ip link set veth1b netns $NS
sudo ip netns exec $NS ip addr add 10.0.0.2/24 dev veth1b
sudo ip netns exec $NS ip link set veth1b up

sudo ip netns exec $NS \
    sudo -u ubuntu -- \
    unshare --map-root-user \
    unshare --pid --mount-proc --fork \
    unshare --mount \
    "$@"

sudo ip netns del netns1
